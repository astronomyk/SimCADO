Using PSFs with SimCADO
=======================

Point spread function (PSF) kernels are used by SimCADO to mimic the spread in
the beam due to the specific optical configuration of the ELT+MAORY+MICADO
optical system.

A PSF kernel is in essence a two dimensional array which describes how the
light from a point source is spread out over the detector plane. While SimCADO
can accept 2D numpy arrays as input directly from the user, more often than not
the user will probably want to use a set of pre-calculated PSFs.


Default PSFs for MICADO
-----------------------

.. warning:: The default PSFs are approaching their expiry date

    The PSF files described below are useful for quick simulations which don't
    require a super accurate PSF. Furthermore they were generated in
    2015 (MCAO, NOVA), and 2016 (SCAO, LESIA), and only cover a single set of
    atmospheric parameters.

    For newer PSFs, see the section on SCAO PSFs (from AnisoCADO) or contact
    the SimCADO team about MCAO PSFs (from MAROY)


By default the MICADO instrument package includes PSF kernels (arrays) in FITS
format for the MCAO and SCAO observing modes. These default kernel FITS files
are found in the MICADO data folder under the names: ``PSF_MCAO.fits``,
``PSF_SCAO.fits``.

SimCADO can be told to use either one of these PSFs by passing the
``SCOPE_PSF_FILE`` keyword to either the ``simcado.run`` function, or to a
``UserCommands`` dictionary::

    hdu = simcado.run(... , SCOPE_PSF_FILE="PSF_MCAO.fits")

or::

    cmds = simcado.UserCommands()
    cmds["SCOPE_PSF_FILE"] = "PSF_MCAO.fits"

.. note:: The default PSFs are field-constant.

    This means that they do not vary over the field of view. For the MCAO option
    this is the optimal case - a constant AO correction everywhere in the field
    - however for the SCAO case, this is only valid for the central ~2x2 arcsec.

    If we are interested in simulating the full MICADO field of view, it
    will be unrealistic to use the ``PSF_SCAO.fits`` file. More on this below.

Both the MCAO and SCAO files were generated for reasonably good conditions and
should be understood as offering an optimistic view of how MICADO will perform.


Field varying SCAO PSF
----------------------

As stated above the default PSFs contained in the MICADO package are for the
case where the PSF doesn't vary over the field. For the SCAO observation modes
this is an unrealistic assumption unless one is only interested in the central
~2x2 arcsec or so. SimCADO (v0.6 and above) accepts a so-called FV-PSF file
(field-varying PSF file) in order to simulate the degredation of the PSF over
the field of view.

FV-PSF files are quite large (several 100 MB to GB) as they contain PSF kernels
for many different positions over the field (and generally for several different
wavelengths).

We have generated SCAO FV-PSF files for three observing conditions which roughly
correspond to "good", "median", and "bad" atmospheric conditions.

.. warning:: These files are ~1 GB in size.

======= ======= =========== ======= =============== ============================
Profile Seeing  Zenith      Wind    Turbulence      File Link
                Distance    Speed   Profile
------- ------- ----------- ------- --------------- ----------------------------
        arcsec  degree      m/s     Rel Cn2
======= ======= =========== ======= =============== ============================
Good    0.4     0           8.8     ESO Quartile 1  AnisoCADO_Q1_
Median  0.67    30          10      ESO Median      AnisoCADO_Median_
Bad     1.0     60          13      ESO Quartile 4  AnisoCADO_Q4_
======= ======= =========== ======= =============== ============================

.. _AnisoCADO_Q1: https://www.univie.ac.at/simcado/InstPkgSvr/psfs/AnisoCADO_SCAO_FVPSF_4mas_EsoQ1_20190328.fits
.. _AnisoCADO_Median: https://www.univie.ac.at/simcado/InstPkgSvr/psfs/AnisoCADO_SCAO_FVPSF_4mas_EsoMedian_20190328.fits
.. _AnisoCADO_Q4: https://www.univie.ac.at/simcado/InstPkgSvr/psfs/AnisoCADO_SCAO_FVPSF_4mas_EsoQ4_20190328.fits

.. _AnisoCADO: https://anisocado.readthedocs.io/

This FV-PSFs were generated by AnisoCADO_. AnisoCADO_ is python package derived
from Eric Gendron's code for generating SCAO PSFs for the ELT+MICADO for any
wavelength and off-axis guide star position. To generate custom FV-PSF kernels,
see AnisoCADO_'s documentation for how to make SimCADO-readable FV-PSF FITS
files.

To use these PSF files we simply pass the filename to SimCADO (as with the other
PSF), and SimCADO (! >=v0.6) does the rest::

    fvpsf_path = "path/to/AnisoCADO_SCAO_FVPSF_4mas_EsoQ1_20190328.fits"
    simcado.run(... , SCOPE_PSF_FILE=fvpsf_path)

.. warning:: SimCADO will (probably) run slower when using a FV-PSF file.

    This is because SimCADO convolves the FOV of each detector with each PSF
    kernel that is present inside the borders of that FOV. This means, e.g., if
    there are 9 different PSFs to be used in the region covered by the central
    detector chip, then this region will be convolved 9 times with different
    PSFs (and masked accordingly 9 times). Hence simulating the central chip
    will take 9 times as long as when using a field-constant PSF.

